# .github/workflows/release.yml
name: Release app
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    strategy:
      matrix:
        os:
          [
            { name: 'linux', image: 'ubuntu-latest' },
            { name: 'windows', image: 'windows-latest' },
            { name: 'macos-x64', image: 'macos-15-intel' },
            { name: 'macos-arm64', image: 'macos-14' },
          ]
    runs-on: ${{ matrix.os.image }}
    steps:
      - name: Github checkout
        uses: actions/checkout@v4
      - name: Build whisper.cpp CLI (all platforms)
        shell: bash
        run: |
          set -euo pipefail

          ARCH_DIR="x64"
          PLATFORM_DIR="linux"
          CMAKE_ARCH=""
          if [[ "${{ matrix.os.name }}" == "windows" ]]; then
            PLATFORM_DIR="win32"
          elif [[ "${{ matrix.os.name }}" == "linux" ]]; then
            PLATFORM_DIR="linux"
          else
            PLATFORM_DIR="darwin"
            CMAKE_ARCH="x86_64"
            if [[ "${{ matrix.os.name }}" == "macos-arm64" ]]; then
              ARCH_DIR="arm64"
              CMAKE_ARCH="arm64"
            fi
          fi

          WORK_DIR="$(mktemp -d)"
          git clone --depth 1 https://github.com/ggml-org/whisper.cpp.git "$WORK_DIR/whisper.cpp"
          cd "$WORK_DIR/whisper.cpp"

          if [[ "${{ matrix.os.name }}" == "windows" ]]; then
            cmake -S . -B build -A x64 \
              -DWHISPER_BUILD_EXAMPLES=ON \
              -DWHISPER_BUILD_TESTS=OFF \
              -DWHISPER_BUILD_SERVER=OFF \
              -DWHISPER_SDL2=OFF \
              -DCMAKE_BUILD_TYPE=Release
            cmake --build build --config Release -j "${NUMBER_OF_PROCESSORS:-4}"
          elif [[ "${{ matrix.os.name }}" == "linux" ]]; then
            cmake -S . -B build \
              -DWHISPER_BUILD_EXAMPLES=ON \
              -DWHISPER_BUILD_TESTS=OFF \
              -DWHISPER_BUILD_SERVER=OFF \
              -DWHISPER_SDL2=OFF \
              -DCMAKE_BUILD_TYPE=Release
            cmake --build build --config Release -j "$(nproc)"
          else
            cmake -S . -B build \
              -DWHISPER_BUILD_EXAMPLES=ON \
              -DWHISPER_BUILD_TESTS=OFF \
              -DWHISPER_BUILD_SERVER=OFF \
              -DWHISPER_SDL2=OFF \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_OSX_ARCHITECTURES="${CMAKE_ARCH}"
            cmake --build build --config Release -j "$(sysctl -n hw.logicalcpu)"
          fi

          WHISPER_BIN="$(find build -type f \( -name 'whisper-cli' -o -name 'whisper-cli.exe' \) | head -n 1)"
          if [[ -z "${WHISPER_BIN}" ]]; then
            echo "whisper-cli not found in build output" >&2
            exit 1
          fi

          if ! "${WHISPER_BIN}" --help | grep -q -- '--vad'; then
            echo "whisper-cli does not report VAD flags; build likely missing VAD support" >&2
            exit 1
          fi

          DEST="${GITHUB_WORKSPACE}/lib/whisper.cpp/${ARCH_DIR}/${PLATFORM_DIR}"
          mkdir -p "${DEST}"
          EXE_NAME="whisper-cli"
          if [[ "${PLATFORM_DIR}" == "win32" ]]; then
            EXE_NAME="whisper-cli.exe"
          fi
          cp "${WHISPER_BIN}" "${DEST}/${EXE_NAME}"
          chmod +x "${DEST}/${EXE_NAME}" || true

          if [[ "${PLATFORM_DIR}" == "darwin" ]]; then
            METAL_FILE="$(find build -type f -name 'ggml-metal.metal' | head -n 1 || true)"
            if [[ -n "${METAL_FILE}" ]]; then
              cp "${METAL_FILE}" "${DEST}/ggml-metal.metal"
            fi
            WHISPER_LIBS="$(find build -type f \( -name 'libwhisper*.dylib' -o -name 'libggml*.dylib' \) || true)"
            if [[ -n "${WHISPER_LIBS}" ]]; then
              while IFS= read -r dylib; do
                [[ -z "${dylib}" ]] && continue
                cp "${dylib}" "${DEST}/"
              done <<< "${WHISPER_LIBS}"
            fi
            # Ensure rpath short-name dylibs exist (e.g., libwhisper.1.dylib).
            pushd "${DEST}" >/dev/null
            for f in lib*.dylib; do
              if [[ "${f}" =~ ^(lib[^.]+)\.([0-9]+)\..*\.dylib$ ]]; then
                short="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}.dylib"
                ln -sf "${f}" "${short}"
              fi
            done
            # Fix LC_RPATH so dyld resolves libs from the bundled directory.
            for bin in whisper-cli lib*.dylib; do
              [[ -f "${bin}" ]] || continue
              install_name_tool -add_rpath "@loader_path" "${bin}" || true
              rpaths=$(otool -l "${bin}" | awk '/cmd LC_RPATH/{getline; getline; print $2}')
              while IFS= read -r rp; do
                [[ -z "${rp}" ]] && continue
                if [[ "${rp}" == /var/folders/* || "${rp}" == /tmp/* ]]; then
                  install_name_tool -delete_rpath "${rp}" "${bin}" || true
                fi
              done <<< "${rpaths}"
            done
            popd >/dev/null
          elif [[ "${PLATFORM_DIR}" == "linux" ]]; then
            WHISPER_LIBS="$(find build -type f \( -name 'libwhisper*.so*' -o -name 'libggml*.so*' \) || true)"
            if [[ -n "${WHISPER_LIBS}" ]]; then
              while IFS= read -r sofile; do
                [[ -z "${sofile}" ]] && continue
                cp "${sofile}" "${DEST}/"
              done <<< "${WHISPER_LIBS}"
            fi
          else
            WHISPER_DLLS="$(find build -type f -name '*.dll' || true)"
            if [[ -n "${WHISPER_DLLS}" ]]; then
              while IFS= read -r dll; do
                [[ -z "${dll}" ]] && continue
                cp "${dll}" "${DEST}/"
              done <<< "${WHISPER_DLLS}"
            fi
          fi

          ls -la "${DEST}"
      - name: Pack whisper.cpp
        shell: bash
        run: |
          set -euo pipefail

          ARCH_DIR="x64"
          PLATFORM_DIR="linux"
          PLATFORM_KEY="linux"
          if [[ "${{ matrix.os.name }}" == "windows" ]]; then
            PLATFORM_DIR="win32"
            PLATFORM_KEY="windows"
          elif [[ "${{ matrix.os.name }}" == "linux" ]]; then
            PLATFORM_DIR="linux"
            PLATFORM_KEY="linux"
          else
            PLATFORM_DIR="darwin"
            PLATFORM_KEY="macos"
            if [[ "${{ matrix.os.name }}" == "macos-arm64" ]]; then
              ARCH_DIR="arm64"
            fi
          fi

          DEST="${GITHUB_WORKSPACE}/lib/whisper.cpp/${ARCH_DIR}/${PLATFORM_DIR}"
          if [[ ! -d "${DEST}" ]]; then
            echo "whisper.cpp output not found at ${DEST}" >&2
            exit 1
          fi

          if [[ "${PLATFORM_DIR}" == "win32" ]]; then
            ARCHIVE="${GITHUB_WORKSPACE}/whisper.cpp-${PLATFORM_KEY}-${ARCH_DIR}.zip"
            if command -v pwsh >/dev/null 2>&1; then
              pwsh -NoProfile -Command "Compress-Archive -Force -Path '${DEST}' -DestinationPath '${ARCHIVE}'"
            else
              powershell -NoProfile -Command "Compress-Archive -Force -Path '${DEST}' -DestinationPath '${ARCHIVE}'"
            fi
          else
            ARCHIVE="${GITHUB_WORKSPACE}/whisper.cpp-${PLATFORM_KEY}-${ARCH_DIR}.tar.gz"
            tar -czf "${ARCHIVE}" -C "${GITHUB_WORKSPACE}/lib" "whisper.cpp/${ARCH_DIR}/${PLATFORM_DIR}"
          fi
          ls -la "${ARCHIVE}"
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0
          cache: yarn
      - name: Install WiX Toolset (Windows only)
        if: matrix.os.name == 'windows'
        run: |
          choco install wixtoolset
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $GITHUB_PATH
      - run: yarn install --frozen-lockfile
      - name: Publish app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run publish
      - name: Upload whisper.cpp to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./package.json').version")"
          TAG="v${VERSION}"
          ARCHIVE="$(ls -1 ${GITHUB_WORKSPACE}/whisper.cpp-* | head -n 1)"
          if [[ -z "${ARCHIVE}" || ! -f "${ARCHIVE}" ]]; then
            echo "whisper.cpp archive not found in workspace" >&2
            exit 1
          fi
          gh release upload "${TAG}" "${ARCHIVE}" --clobber
