# .github/workflows/release.yml
name: Release app
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    strategy:
      matrix:
        os:
          [
            { name: 'linux', image: 'ubuntu-latest' },
            { name: 'windows', image: 'windows-latest' },
            { name: 'macos-x64', image: 'macos-15-intel' },
            { name: 'macos-arm64', image: 'macos-14' },
          ]
    runs-on: ${{ matrix.os.image }}
    steps:
      - name: Github checkout
        uses: actions/checkout@v4
      - name: Build whisper.cpp CLI (macOS only)
        if: startsWith(matrix.os.name, 'macos')
        run: |
          set -euo pipefail
          ARCH_DIR="x64"
          CMAKE_ARCH="x86_64"
          if [[ "${{ matrix.os.name }}" == "macos-arm64" ]]; then
            ARCH_DIR="arm64"
            CMAKE_ARCH="arm64"
          fi

          WORK_DIR="$(mktemp -d)"
          git clone --depth 1 https://github.com/ggml-org/whisper.cpp.git "$WORK_DIR/whisper.cpp"
          cd "$WORK_DIR/whisper.cpp"
          cmake -B build \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_SERVER=OFF \
            -DWHISPER_SDL2=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES="${CMAKE_ARCH}"
          cmake --build build --config Release -j "$(sysctl -n hw.logicalcpu)"

          WHISPER_BIN="$(find build -type f -name 'whisper-cli' | head -n 1)"
          if [[ -z "${WHISPER_BIN}" ]]; then
            echo "whisper-cli not found in build output" >&2
            exit 1
          fi

          METAL_FILE="$(find build -type f -name 'ggml-metal.metal' | head -n 1 || true)"
          WHISPER_LIBS="$(find build -type f \( -name 'libwhisper*.dylib' -o -name 'libggml*.dylib' \) || true)"

          DEST="${GITHUB_WORKSPACE}/lib/whisper.cpp/${ARCH_DIR}/darwin"
          mkdir -p "${DEST}"
          cp "${WHISPER_BIN}" "${DEST}/whisper-cli"
          chmod +x "${DEST}/whisper-cli"
          if [[ -n "${METAL_FILE}" ]]; then
            cp "${METAL_FILE}" "${DEST}/ggml-metal.metal"
          fi
          if [[ -n "${WHISPER_LIBS}" ]]; then
            while IFS= read -r dylib; do
              [[ -z "${dylib}" ]] && continue
              cp "${dylib}" "${DEST}/"
            done <<< "${WHISPER_LIBS}"
          fi
          ls -la "${DEST}"
      - name: Pack whisper.cpp (macOS arm64 only)
        if: matrix.os.name == 'macos-arm64'
        run: |
          set -euo pipefail
          DEST="${GITHUB_WORKSPACE}/lib/whisper.cpp/arm64/darwin"
          ARCHIVE="${GITHUB_WORKSPACE}/whisper.cpp-macos-arm64.tar.gz"
          if [[ ! -d "${DEST}" ]]; then
            echo "whisper.cpp output not found at ${DEST}" >&2
            exit 1
          fi
          tar -czf "${ARCHIVE}" -C "${GITHUB_WORKSPACE}/lib" "whisper.cpp/arm64/darwin"
          ls -la "${ARCHIVE}"
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.12.0
          cache: yarn
      - name: Install WiX Toolset (Windows only)
        if: matrix.os.name == 'windows'
        run: |
          choco install wixtoolset
          echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $GITHUB_PATH
      - run: yarn install --frozen-lockfile
      - name: Publish app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run publish
      - name: Upload whisper.cpp to Release (macOS arm64 only)
        if: matrix.os.name == 'macos-arm64'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./package.json').version")"
          TAG="v${VERSION}"
          ARCHIVE="${GITHUB_WORKSPACE}/whisper.cpp-macos-arm64.tar.gz"
          if [[ ! -f "${ARCHIVE}" ]]; then
            echo "whisper.cpp archive not found at ${ARCHIVE}" >&2
            exit 1
          fi
          gh release upload "${TAG}" "${ARCHIVE}" --clobber
